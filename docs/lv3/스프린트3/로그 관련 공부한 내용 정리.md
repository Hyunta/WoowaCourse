# 꼭꼭 로그 정리

<목차>

Slf4J 와 Logback

Logback의 사용 방법

- Appender 설정 방법
- 로그를 찍는 방법

로그를 어떻게 관리할 것인가?

- AOP vs Interceptor vs Filter

MDC에서 traceId를 사용한 이유

@EnableAspectJAutoProxy 를 생략해도 되는 이유



## SLF4J 와 Logback

slf4j는 다양한 로깅 프레임 워크(logback, log4j 등)에 대한 인터페이스 역할을 하는 라이브러리다,.

![https://user-images.githubusercontent.com/48986787/125076883-6b819680-e0fb-11eb-96fb-c1a344bc45d0.png](https://user-images.githubusercontent.com/48986787/125076883-6b819680-e0fb-11eb-96fb-c1a344bc45d0.png)

스프링 부트에서 기본적으로 SLF4J 와 Logback을 사용하고 있어서, 스프링 부트 환경에서 프로젝트를 만든다면 추가적으로 의존성 주입을 받아주지 않아도 사용 가능합니다.

<img src="/Users/kimhyuntae/Library/Application Support/typora-user-images/image-20220803155153837.png" alt="image-20220803155153837" style="zoom:50%;" />



## Logback 사용 방법

스프링에서 Logback을 사용 하기 위해서 xml 파일을 만들어줘야합니다.

<img src="/Users/kimhyuntae/Library/Application Support/typora-user-images/image-20220803155617974.png" alt="image-20220803155617974" style="zoom:50%;" />

logback-spring.xml을 만들어서 Logback을 customize해서 사용했습니다.  공식문서에서는 스프링이 로그 초기화를 완전히 컨트롤할 수 없기 때문에 logback.xml 보다는 logback-spring.xml 형식을 권장합니다. logback.xml의 경우 너무 일찍 로딩되기 때문에 extensions을 사용할 수 없다고 합니다.



<logback-spring.xml>

```xml


<?xml version="1.0" encoding="UTF-8"?>

<configuration scan="true" scanPeriod="30 seconds"> ## 30초마다 스캔해서 파일에 변동이 있으면
  <timestamp key="BY_DATE" datePattern="yyyy-MM-dd"/> ## 시간의 형식을 나타냄
  <property name="LOG_PATTERN"
    value="[%d{yyyy-MM-dd HH:mm:ss}:%-4relative] %green([%thread]) %yellow([traceId=%X{trace_id}]) %highlight(%-5level) : %msg%n"/> ## 로그가 찍히는 양식을 정해줌

  <springProfile name="!prod">
    <include resource="console-appender.xml"/>

    <root level="INFO"> ## 로그의 기반 레벨을 INFO로 지정(INFO-WARN-ERROR 출력)
      <appender-ref ref="CONSOLE"/> ## 해당 appender를 적용한다.
    </root>
  </springProfile>

  <springProfile name="prod">
    <include resource="file-info-appender.xml"/>
    <include resource="file-error-appender.xml"/>
    <include resource="file-all-appender.xml"/>

    <root level="INFO">
      <appender-ref ref="FILE-INFO"/>
      <appender-ref ref="FILE-ERROR"/>
      <appender-ref ref="FILE-ALL"/>
    </root>
  </springProfile>
</configuration>

```



<console-appender.xml>

```xml
<included>
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder> ## 로그를 우리가 원하는데로 작성해줌
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>
</included>

```



<file-info-appender.xml>

```xml
<included>
    <appender name="FILE-INFO" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>./.log/info/info-${BY_DATE}.log</file> ## 해당 경로와 이름으로 로그가 저장됨
        <filter class="ch.qos.logback.classic.filter.LevelFilter"> ## 발생하는 로그들의 레벨에 따라 파일을 작성할지 말지를 결정함
            <level>INFO</level>
            <onMatch>ACCEPT</onMatch> ## INFO에 일치하면 작성
            <onMismatch>DENY</onMismatch> ## INFO에 일치하지 않으면 작성하지 않음
        </filter>
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy"> ## Size와 Time에 기반하여 로그를 백업한다
            <fileNamePattern>./backup/info/info-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <maxFileSize>100MB</maxFileSize> ## 한 파일의 최대 용량 100MB
            <maxHistory>30</maxHistory> ## 30일 이후에 삭제됨
            <totalSizeCap>3GB</totalSizeCap>## 모든 저장 로그가 합 3GB가 넘으면 삭제함
        </rollingPolicy>
    </appender>
</included>

```



logback-spring.xml을 설정하고 코드 내부에서 SLF4J의 LoggerFactory를 이용해서 원하는 형식의 log를 남길 수 있게된다.

```
[2022-08-03 17:01:41:8665] [http-nio-8080-exec-1] [traceId=0dce984e-91e0-4305-b7ce-6277367f9064] INFO  : 로그 출력 메세지
```





## 로그를 어디서 찍을 것인가?

일단 컨트롤러의 모든 메서드에서 요청과 응답에 대한 로그를 관리하기로 했습니다. 공통된 코드를 분리시키기 위해서 AOP를 이용했습니다.



아래 부터는 LogAspect 클래스에 대한 설명입니다.

```java
@Pointcut("execution(* com.woowacourse.kkogkkog.presentation.*.*(..) )")
public void controllerAdvice() {}
```

@Pointcut은 쉽게 말하면 끼어드는 위치입니다. controllerAdvice()는 presentation 패키지의 모든 메서드에 대해서, 실행이 될 때 작동합니다.



```java
    @Before("controllerAdvice()")
    public void requestLogging() {
        ServletRequestAttributes servletRequestAttributes = (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes();
        HttpServletRequest request = servletRequestAttributes.getRequest();

        MDC.put(TRACING_ID, UUID.randomUUID().toString());
        log.info("Request : {} {}, requestParams = ({}),", request.getMethod(),
            request.getRequestURL(), paramMapToString(request.getParameterMap()));
    }
```

@Before은 타겟 메서드가 호출되기 전에 수행합니다. 현재 HttpServletRequest를 받아와서 HttpMethod와 요청 URL 그리고 파라미터들을 출력하도록 구현했습니다.

추가로 MDC에 추가하는 tracingId는 request부터 response까지 같이 관리하기 위해서 추가했습니다.

<Request 예시>

`[2022-08-04 10:20:10:61735816] [http-nio-8080-exec-6] [traceId=0b0fd4a3-5fd9-439e-b5b3-b7786a778769] INFO  : Request : GET http://localhost:8080/api/members, requestParams = (),`

```java
    @AfterReturning(pointcut = "controllerAdvice()", returning = "returnValue")
    public void responseLogging(JoinPoint joinPoint, Object returnValue) {
        ResponseEntity<Object> responseEntity = (ResponseEntity<Object>) returnValue;
        log.info("Response {} : {}", responseEntity.getStatusCode(), joinPoint.getSignature().getName());
        MDC.clear();
    }

```

@AfterReturning은 정상적인 반환 이후 수행합니다. 현재 반환한 상태 코드와 마지막에 수행한 메서드 이름을 남기도록했습니다. returning에 작성한 이름으로 반환 객체를 생성해줍니다.

추가로 @Before에서 만들어둔 traceId를 삭제하는 작업을 진행합니다.

<Response 예시>

`[2022-08-03 17:11:23:8656] [http-nio-8080-exec-1] [traceId=9417d45c-63bd-4fcc-8028-d64c1f0cda0d] INFO  : Response 200 OK : showAll`



```java
    @AfterThrowing(pointcut = "controllerAdvice()", throwing = "exception")
    public void exceptionLogging(Exception exception) {
        log.info("Exception has been thrown : ", exception);
        MDC.clear();
    }
```

@AfterThrowing은 예외 발생 이후 수행합니다. 현재 발생한 예외를 기록하도록 설정해뒀습니다.



<Exception 예시>

```
[2022-08-04 10:19:59:61724476] [http-nio-8080-exec-5] [traceId=587274aa-68b5-4ab1-9c7b-ca5ddf0bd48d] INFO  : Exception has been thrown : 
com.woowacourse.kkogkkog.exception.auth.AccessTokenRetrievalFailedException: 슬랙 서버로부터 토큰 조회에 실패하였습니다.
	at com.woowacourse.kkogkkog.infrastructure.SlackClient.validateResponseBody(SlackClient.java:86)
	at com.woowacourse.kkogkkog.infrastructure.SlackClient.requestAccessToken(SlackClient.java:66)
	at com.woowacourse.kkogkkog.infrastructure.SlackClient.getUserInfoByCode(SlackClient.java:53)
	at com.woowacourse.kkogkkog.application.AuthService.login(AuthService.java:27)
	at com.woowacourse.kkogkkog.application.AuthService$$FastClassBySpringCGLIB$$63af18b0.invoke(<generated>)
	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:793)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:763)
	at org.springframework.transaction.interceptor.TransactionInterceptor$1.proceedWithInvocation(TransactionInterceptor.java:123)
	at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:388)
	at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:119)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:763)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:708)
	at com.woowacourse.kkogkkog.application.AuthService$$EnhancerBySpringCGLIB$$b2c1740e.login(<generated>)
	at com.woowacourse.kkogkkog.presentation.AuthController.login(AuthController.java:23)
	at com.woowacourse.kkogkkog.presentation.AuthController$$FastClassBySpringCGLIB$$1abe68d9.invoke(<generated>)
	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:793)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:763)
	at org.springframework.aop.aspectj.AspectJAfterThrowingAdvice.invoke(AspectJAfterThrowingAdvice.java:64)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:763)
	at org.springframework.aop.framework.adapter.AfterReturningAdviceInterceptor.invoke(AfterReturningAdviceInterceptor.java:57)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:763)
	at org.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor.invoke(MethodBeforeAdviceInterceptor.java:58)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:763)
	at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:97)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:763)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:708)
	at com.woowacourse.kkogkkog.presentation.AuthController$$EnhancerBySpringCGLIB$$6fdcc2c3.login(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:566)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:205)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:150)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:117)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:895)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:808)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1067)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:963)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1006)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:898)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:655)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:883)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:764)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:227)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:162)
	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:53)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:189)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:162)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:117)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:189)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:162)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:117)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:189)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:162)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:117)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:189)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:162)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:197)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:97)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:541)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:135)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:92)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:78)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:360)
	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:399)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:65)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:890)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1787)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1191)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
	at java.base/java.lang.Thread.run(Thread.java:834)
```



#### Reference

https://tecoble.techcourse.co.kr/post/2021-08-07-logback-tutorial/

https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.logging

https://engkimbs.tistory.com/746
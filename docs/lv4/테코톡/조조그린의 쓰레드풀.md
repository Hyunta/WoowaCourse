## 쓰레드 풀 

java, Tomcat, SpringBoot



### 프로그램, 프로세스, 쓰레드

CPU Core의 실행 단위가 Thread이다. thread를 사용하면서 하나의 프로세스에서 동시에 작업을 할 수 있다.

문제 1 Thread 생성비용이 크기때문에 시간이 많이 걸린다.

Java는 One to One Threading Model / 새로운 thread를 생성할때마다 Kernel의 작업이 필요하다. Thread는 생성 비용이 많이 든다.

요청이 올때마다 thread를 생성하면 시간이 오래 걸린다.



Thread가 너무 많으면 여러가지 문제를 발생한다. CPU의 처리 속도 보다 Thread가 무제한 적으로 생기고 ContextSwitching으로 인해 비용이 발생한다. 오히려 느려진다.



### Thread Pool

허용된 개수안에서 제한적으로 사용할 수 있는 구조

최대 갯수 n 개 + 작업큐로 내부적으로 존재한다.

쓰레드 풀이 생성될 때 쓰레드를 어느정도 생성해두고 사용한다.



### JAVA의 Thread Pool

ThreadPool Executor에 작업이 들어오면 work queue에 들어오게 된다. task가 큐에 쌓이고 Thread는 받아서 작업을 처리한다.



### Tomcat의 Thread Pool

Java 기반의 WAS

acceptCoint -> maxConnections -> maxThreads

톰캣의 Connector가 Connection을 생성하고 처리한다.



acceptCount maxConnections 이상의 작업이 들어왔을 떄 acceptCount 만큼의 큐에 저장이 된다.

둘다 꽉차면 추가적으로 요청이 오는 것은 거절될 수 잇다.

ThreadPool에서 사용할 최대 쓰레드 개수, 기본값은 200

요청수에 비해 너무 많게 설정 -> 놀고있는 스레드가 많아져서 비효율 발생

너무 적게 설정 -> 동시 처리 요청수가 줄어든다.



min-spare : 쓰레드풀에 최소한으로 유지할 Thread 갯수

NIO는 ThreadPool의 최대 쓰레드 개수보다 많은 양의 Connection을 유지할 수 있다.

최대 Thread 개수보다 적은 수의 max-connections를 설정하는 것은 비효율적인 설정이 될 수 있다.



max-connections 이상의 요청이 들어왔을 때 사용하는 요청 대기열 Queue의 사이즈

부적절하거나 잘못된 요청이 한번에 너무 많이 들어와 장애를 발생시킬 수 있기 때문에 설정한다.



잘 조정된 threadPool이 성능을 보장한다.